package mysql

import (
	"encoding/json"
	"fmt"
	"sync"

	"github.com/dop251/goja"
)

// See vis-transformer.js for the prettified source of this.
// Use Babel for transpilation to ES5

const jsSrc = `
'use strict';function transform(a){function d(k,l){this.randomId=function(){return Math.random().toString(36).substring(2,18)+Math.random().toString(36).substring(2,18)},this.s={startId:'start111',conNode:'conNode',conEdge:'conEdge'},this.options={nodes:{start:{connections:{from:[{node:{shape:'dot',size:10,color:{background:'#8dd5ff',border:'#7b7b7b',highlight:{background:'#8dd5ff',border:'#7b7b7b'}},borderWidth:1,borderWidthSelected:1},edge:{arrowStrikethrough:!1,arrows:'to',width:2,hoverWidth:4,selectionWidth:4,color:{color:'#45bbff',highlight:'#45bbff',hover:'#45bbff'}}}],to:0},shape:'icon',icon:{face:'FontAwesome',code:'\uF152',size:80,color:'#45bbff'}},con:{}},events:{hoverIn:null,hoverOut:null,insert:null,remove:null,click:null,dblclick:null},node:{connections:{from:[{node:{shape:'dot',size:10,color:{background:'#45bbff',border:'#7b7b7b',highlight:{background:'#8dd5ff',border:'#7b7b7b'},hover:{background:'#8dd5ff',border:'#7b7b7b'}},borderWidth:1,borderWidthSelected:1},edge:{arrowStrikethrough:!1,arrows:'to',width:1,hoverWidth:2,selectionWidth:2,color:{color:'#45bbff',highlight:'#45bbff',hover:'#45bbff'}}}],to:Infinity,space:1.1},shadow:{enabled:!0,color:'rgba(0,0,0,0.5)',size:10,x:5,y:5}}},this.options=h(!0,this.options,l);var o,m={};for(var p in this.options.nodes)this.options.nodes.hasOwnProperty(p)&&('con'===p?o=this.options.nodes[p]:(o={},o=h(!0,o,this.options.node,this.options.nodes[p],{connections:null,events:null}),delete o.connections,delete o.events),m[p]=o);this.networkOptions={groups:m,interaction:{dragNodes:!0,tooltipDelay:200,hover:!0,navigationButtons:!0,selectable:!0,selectConnectedEdges:!0,keyboard:!0},manipulation:{enabled:!1},edges:{font:{size:10},smooth:{enabled:!0,forceDirection:'none'}},nodes:{font:{size:18}},physics:{stabilization:{enabled:!0,onlyDynamicEdges:!1,fit:!0},barnesHut:{gravitationalConstant:-850,centralGravity:0.00001,springLength:200,springConstant:0.0885,damping:0.6,avoidOverlap:0},repulsion:{centralGravity:2e-3,springLength:200,springConstant:0.08,nodeDistance:100,damping:0.8},timestep:1,adaptiveTimestep:!1,maxVelocity:50,minVelocity:0.4,solver:'barnesHut'}}}var f={};f.log=function(){},String.prototype.startsWith||function(){'use strict';var k=function(){try{var o={},p=Object.defineProperty,q=p(o,o,o)&&p}catch(r){}return q}(),l={}.toString,m=function(o){if(null==this)throw TypeError();var p=this+'';if(o&&'[object RegExp]'==l.call(o))throw TypeError();var q=p.length,r=o+'',s=r.length,t=1<arguments.length?arguments[1]:void 0,u=t?+t:0;u!=u&&(u=0);var v=Math.min(Math.max(u,0),q);if(s+v>q)return!1;for(var x=-1;++x<s;)if(p.charCodeAt(v+x)!=r.charCodeAt(x))return!1;return!0};k?k(String.prototype,'startsWith',{value:m,configurable:!0,writable:!0}):String.prototype.startsWith=m}();var g=function(){this.body={},this.body.nodes={},this.body.edges={},this.body.data={},this.body.data.nodes={},this.body.data.nodes._data={},this.body.data.edges={},this.body.data.edges._data={}};g.prototype.fit=function(){},g.prototype.storePositions=function(){};var h=function(){var k={},l=!1,m=0,o=arguments.length;'[object Boolean]'===Object.prototype.toString.call(arguments[0])&&(l=arguments[0],m++);for(var q,p=function(r){for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(k[s]=l&&'[object Object]'===Object.prototype.toString.call(r[s])?h(!0,k[s],r[s]):r[s])};m<o;m++)q=arguments[m],p(q);return k};d.prototype.workflowDataToVis=function(k){f.log('wfdata before transofrm in vis-flowchart'),f.log(k);var l={nodes:[],edges:[]},m=this.getConnectionSettings('start'),o={id:this.s.startId,label:'start',physics:!1,group:'start',connections:m};m.from=[],this.mergeConnectionFromSettings(o,{value:o.id},0),this.mergeNodeEvents(o),this.createConNode(l,o,0);var p=function(B,C){'number'==typeof C[B]?C[B]++:C[B]=1},q=o;if(l.nodes.push(o),k){var r,s;if(0<k.length){var t={},u={};l.edges.push(this.createEdge('start',{from:o.id,to:k[0].id},0)),p(k[0].id,t);try{q.x=k[0].p.start.x,q.y=k[0].p.start.y}catch(B){}for(var v=0;v<k.length;++v){if(r=k[v],'step'===r.type&&(r.type='form'),o=this._createNode(r),u[o.id]=o,l.nodes.push(o),o._data=r.data,'condition'===r.type){o._cases=[];for(var x=0;x<r.cases.length;x++)r.cases[x].name=r.cases[x].label,o._cases.push({name:r.cases[x].label,value:r.cases[x].value}),this.mergeConnectionFromSettings(o,r.cases[x],x),this.createConNode(l,o,x)}else this.mergeConnectionFromSettings(o,{value:o.id},0),o.uriName=r.uriName,this.createConNode(l,o,0);if(this.mergeNodeEvents(o),r.connectedTo&&r.connectedTo.length)for(var y=0;y<r.connectedTo.length;++y)if(s=r.connectedTo[y],p(s.targetId,t),'condition'===r.type){l.edges.push(this.createEdge(r.type,{from:r.id,to:s.targetId},y,s));for(var z=0;z<o.connections.from.length;++z)o.connections.from[z].value==s.value&&o.connections.from[z].hide(this)}else l.edges.push(this.createEdge(r.type,{from:r.id,to:s.targetId},0)),o.connections.from[0].hide(this)}for(var A in t)A&&t.hasOwnProperty(A)&&(u[A].connections.toCount=t[A])}}return f.log('dataResult from vis-flowchart'),f.log(l),l},d.prototype.nodes=null,d.prototype.edges=null,d.prototype.network=new g,d.prototype.seed=2,d.prototype.createConFromNode=function(k,l,m){var o=this.getMergedNode(k,l,m);o.physics=!1,o.id=this.s.conNode+'_'+k.id+(m.value?'_'+m.value:'')+'_'+l,o.group='con',o._isCon=!0,o._from_={parentId:k.id,index:l},'number'==typeof k.x&&(o.x=k.x),'number'==typeof k.y&&(o.y=k.y);var p=this.createEdge(k.group,{from:k.id,to:o.id},l,m);return p.arrows&&delete p.arrows,p.id=this.s.conEdge+'_'+p.id,p._isCon=!0,m.notAvailable&&(o.hidden=!0,p.hidden=!0,p.physics=!1),m.ne={n:o,e:p},m.ne},d.prototype.getMergedNode=function(k,l,m){var o;if('number'==typeof l)try{o=this.options.nodes[k.group].connections.from[l].node}catch(r){}if(!o)try{o=this.options.nodes[k.group].connections.from[0].node}catch(r){}var p;m&&m.node&&(p=m.node);var q={};return q=h(!0,q,this.options.node.connections.from[0].node,o,p),q},d.prototype.getFlowData=function(){var s,t,u,v,x,l={start:{},nodes:{}},m=null,o=null,p=null,q=null,r=this.network.body.nodes[this.s.startId],y=this.getStartNodeId();for(r&&y&&(o=r,q={x:o.x,y:o.y},l.start.p=q,l.start.node=y),t=0;t<this.network.body.nodeIndices.length;++t)if(s=this.network.body.nodeIndices[t],!(s===this.s.startId||s.startsWith(this.s.conNode))){m=this.getNodeById(s),o=this.network.body.nodes[m.id],l.nodes[s]=p={id:m.id,name:m.label,detail:m.detail?m.detail:'',type:m.group,p:{x:o.x,y:o.y},conns:[]},m._cases&&(p.cases=m._cases),m._data&&(p.data=m._data);var z=this.getEdgesByNode(o);for(u=0;u<z.length;++u)v=z[u],v.id.startsWith(this.s.conEdge)||v.to===m.id||(v=this.getEdgeById(v.id),x={id:v.to},p.id!==v.cvalue&&(x.value=v.cvalue),p.conns.push(x))}return l},d.prototype.getEdgesByNode=function(k){var o=this,l=[],m=Object.keys(this.network.body.edges);return m.forEach(function(p){(o.network.body.edges[p].from===k.id||o.network.body.edges[p].to===k.id)&&l.push(o.network.body.edges[p])}),l},d.prototype.getStartNodeId=function(){var m=this,k=Object.keys(this.network.body.edges),l='';return k.forEach(function(o){m.network.body.edges[o]&&m.network.body.edges[o].from===m.s.startId&&(l=m.network.body.edges[o].to)}),l},d.prototype.getNodeById=function(k){return this.network.body.data.nodes._data[k]},d.prototype.getEdgeById=function(k){return this.network.body.data.edges._data[k]},d.prototype._createNode=function(k,l){var m=this.getConnectionSettings(k.type);m.from=[],m.toCount=0,k.description&&(k.detail=k.description);var o={id:k.id,label:k.name,detail:k.detail,group:k.type,connections:m};return o.id||(o.id=l,!o.id&&(o.id=this.randomId())),o.title=this.createTooltip(k,o,this.options.showIDOnTooltip),k.p&&(o.x=k.p.x,o.y=k.p.y),o},d.prototype.createTooltip=function(){},d.prototype.mergeConnectionFromSettings=function(k,l,m){k.connections.from.push({});var o;try{o=this.options.nodes[k.group].connections.from[m]}catch(p){}if(!o)try{o=this.options.nodes[k.group].connections.from[0]}catch(p){}k.connections.from[m]=h(!0,k.connections.from[m],this.options.node.connections.from[0],o,l,{hide:function hide(p){this.ne&&p},show:function show(p){this.ne&&p}})},d.prototype.getConnectionSettings=function(k){var l;try{l=this.options.nodes[k].connections}catch(m){}return h(!0,{},this.options.node.connections,l,{from:null})},d.prototype.mergeNodeEvents=function(k){try{k.events=this.options.nodes[k.group].events}catch(l){}},d.prototype.createConNode=function(k,l,m){var o=this.createConFromNode(l,m,l.connections.from[m]);k.nodes.push(o.n),k.edges.push(o.e),o.n.x=l.x,o.n.y=l.y},d.prototype.createEdge=function(k,l,m,o){var p=this.createMergedEdge(k,m,o);return p.from=l.from,p.to=l.to,p.id=l.from+'-'+l.to+'_'+m+'_'+this.randomId(),o?(p.label=o.label?o.label:o.name,p.cvalue=o.value,o.title&&(p.title=o.title)):p.cvalue=l.from,p},d.prototype.createMergedEdge=function(k,l,m){var o;if('number'==typeof l)try{o=this.options.nodes[k].connections.from[l].edge}catch(r){}if(!o)try{o=this.options.nodes[k].connections.from[0].edge}catch(r){}var p;m&&m.edge&&(p=m.edge);var q={};return q=h(!0,q,this.options.node.connections.from[0].edge,o,p),q};var j=new d(a,{showIDOnTooltip:!0,nodes:{start:{connections:{from:[{node:{color:{background:'#45bbff',highlight:{background:'#8dd5ff'},hover:{background:'#8dd5ff'}}},edge:{color:{color:'#45bbff',highlight:'#45bbff',hover:'#45bbff'}}}]},icon:{face:'Material Icons',code:'radio_button_unchecked',size:80,color:'#45bbff'}},collection:{connections:{from:[{node:{color:{background:'#23d6d6',highlight:{background:'#23d6d6'},hover:{background:'#23d6d6'}}},edge:{color:{color:'#23d6d6',highlight:'#23d6d6',hover:'#23d6d6'}}}],fromInfinity:!0,to:Infinity},font:{color:'#343434',size:15,mod:'bold'},icon:{face:'Material Design Icons',code:'\uF765',color:'#1fa6a6'}},form:{connections:{from:[{node:{color:{background:'#60aa61',highlight:{background:'#99d29a'},hover:{background:'#99d29a'}}},edge:{color:{color:'#60aa61',highlight:'#3c763d',hover:'#3c763d'}}}],to:Infinity,space:1.1},font:{color:'#343434',size:15,mod:'bold',bold:{color:'#343434',size:14,face:'arial',vadjust:0,mod:'bold'}},icon:{face:'Material Icons',code:'view_quilt',color:'#62aa44'},events:{}},condition:{connections:{from:[{node:{color:{background:'#f4a646',highlight:{background:'#f9cd95'},hover:{background:'#f9cd95'}}},edge:{font:{align:'middle'},dashes:!0,arrows:'to',color:{color:'#f4a646',highlight:'#e88000',hover:'#e88000'}}}],to:Infinity,space:0.6},font:{color:'#343434',size:15},icon:{face:'Material Design Icons',code:'\uF70B',color:'#f0a30a'},events:{}},workflow:{connections:{from:[{node:{color:{background:'#e40070',highlight:{background:'#f3a3ca'},hover:{background:'#f3a3ca'}}},edge:{color:{color:'#e40070',highlight:'#d60069',hover:'#d60069'}}}],to:Infinity},icon:{face:'Material Design Icons',code:'\uF62C',color:'#e40070'},events:{}},user:{connections:{from:[{node:{color:{background:'#7200ff',highlight:{background:'#c393ff'},hover:{background:'#c393ff'}}},edge:{color:{color:'#7200ff',highlight:'#5b00cc',hover:'#5b00cc'}}}],to:Infinity},icon:{face:'Material Design Icons',code:'\uF004',color:'#7200ff'},events:{}},template:{connections:{from:[{node:{shape:'dot',size:8,color:{background:'#ff30ec',border:'#7b7b7b',highlight:{background:'#ffabf7',border:'#7b7b7b'},hover:{background:'#ffabf7',border:'#7b7b7b'}},borderWidth:1,borderWidthSelected:1},edge:{color:{color:'#ff30ec',highlight:'#e22cd1',hover:'#e22cd1'}}}],to:Infinity},font:{color:'#343434',size:15},icon:{face:'Material Design Icons',code:'\uF22E',color:'#ff30ec'},events:{}}},events:{},node:{connections:{from:[{node:{shape:'dot',size:10,color:{border:'#7b7b7b',highlight:{border:'#7b7b7b'},hover:{border:'#7b7b7b'}},borderWidth:1,borderWidthSelected:1},edge:{arrowStrikethrough:!1,arrows:'to',width:1,hoverWidth:2,selectionWidth:2}}],space:1.1,to:Infinity},shape:'icon',icon:{size:50},shadow:{enabled:!0,color:'rgba(0,0,0,0.1)',size:10,x:5,y:5}}});return f.log('-- network created --'),f.log('network:'),f.log(j),a=j.workflowDataToVis(a),f.log('--- network after wfdatatovis ---'),f.log(j.network),f.log('--- after wfdatatovis: ---'),f.log(a),a.nodes.forEach(function(k){j.network.body.nodes[k.id]=k}),a.edges.forEach(function(k){j.network.body.edges[k.id]=k}),j.network.body.data.nodes.length=a.nodes.length,a.nodes.forEach(function(k){j.network.body.data.nodes._data[k.id]=k}),j.network.body.data.edges.length=a.edges.length,a.edges.forEach(function(k){j.network.body.data.edges._data[k.id]=k}),j.network.body.nodeIndices=[],a.nodes.forEach(function(k){j.network.body.nodeIndices.push(k.id)}),f.log('getflowdata:'),f.log(j.getFlowData(a)),j.getFlowData(a)}

`

var jsgoja *goja.Runtime
var jsgojaSync sync.Mutex

func CompatibilityConvert(jsnBts []byte) []byte {
	if jsgoja == nil {
		jsgojaSync.Lock()
		if jsgoja == nil {
			jsgoja = goja.New()
			_, err := jsgoja.RunString(jsSrc)
			if err != nil {
				fmt.Println(err)
			}
		}
		jsgojaSync.Unlock()
	}
	if jsgoja != nil {
		v, _ := jsgoja.RunString(fmt.Sprintf("transform(%s);", string(jsnBts)))
		abc := v.Export()
		bts, _ := json.Marshal(abc)
		return bts
	}
	return nil
}
