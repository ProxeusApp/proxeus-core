---
version: '3.7'

networks:
  xes-platform-network:
    name: xes-platform-network

services:
  platform:
    build:
      context: .
    container_name: xes-platform
    networks: ['xes-platform-network']
    restart: unless-stopped
    environment:
      TZ: Europe/Zurich
      DataDir: "/data/hosted"
      PlatformDomain: "http://xes-platform:1323"
      DocumentServiceUrl: "http://document-service:2115/"
      BlockchainContractAddress: "${PROXEUS_CONTRACT_ADDRESS}"
      InfuraApiKey: "${PROXEUS_INFURA_KEY}"
      SparkpostApiKey: "${PROXEUS_SPARKPOST_KEY}"
      EmailFrom: "${PROXEUS_EMAIL_FROM:-no-reply@proxeus.com}"
      AirdropWalletfile: "${PROXEUS_AIRDROP_WALLET_FILE:-/root/.proxeus/settings/airdropwallet.json}"
      AirdropWalletkey: "${PROXEUS_AIRDROP_WALLET_KEY:-/root/.proxeus/settings/airdropwallet.key}"
      TestMode: "${PROXEUS_TEST_MODE:-false}"
      DatabaseEngine: "${PROXEUS_DATABASE_ENGINE:-storm}"
      DatabaseURI: "${PROXEUS_DATABASE_URI:-mongodb://root:root@mongo:27017}"
    ports:
      - "1323:1323"
    volumes:
      - ${PROXEUS_DATA_DIR:-./data}/proxeus-platform/data:/data/hosted
      - ${PROXEUS_DATA_DIR:-./data}/proxeus-platform/settings:/root/.proxeus/settings

  document-service:
    image: proxeus/document-service:latest
    container_name: xes_document_service
    networks: ['xes-platform-network']
    restart: unless-stopped
    environment:
      TZ: Europe/Zurich
    ports:
      - "2115:2115"
    volumes:
      - ${PROXEUS_DATA_DIR:-./data}/document-service/logs:/document-service/logs
      - ${PROXEUS_DATA_DIR:-./data}/document-service/fonts:/document-service/fonts

  mongo:
    image: 'bitnami/mongodb:latest'
    networks: ['xes-platform-network']
    ports:
      - 27017:27017
    environment:
      - MONGODB_ADVERTISED_HOSTNAME=mongo
      - MONGODB_REPLICA_SET_MODE=primary
      - MONGODB_ROOT_PASSWORD=root
      - MONGODB_REPLICA_SET_KEY=replica0

  mongo2:
    image: 'bitnami/mongodb:latest'
    depends_on:
      - mongo
    networks: ['xes-platform-network']
    environment:
      - MONGODB_ADVERTISED_HOSTNAME=mongo2
      - MONGODB_REPLICA_SET_MODE=secondary
      - MONGODB_PRIMARY_HOST=mongo
      - MONGODB_PRIMARY_PORT_NUMBER=27017
      - MONGODB_PRIMARY_ROOT_PASSWORD=root
      - MONGODB_REPLICA_SET_KEY=replica0

  mongo3:
    image: 'bitnami/mongodb:latest'
    depends_on:
      - mongo
    networks: ['xes-platform-network']
    environment:
      - MONGODB_ADVERTISED_HOSTNAME=mongo3
      - MONGODB_REPLICA_SET_MODE=arbiter
      - MONGODB_PRIMARY_HOST=mongo
      - MONGODB_PRIMARY_PORT_NUMBER=27017
      - MONGODB_PRIMARY_ROOT_PASSWORD=root
      - MONGODB_REPLICA_SET_KEY=replica0

  mongo-express:
    image: mongo-express
    depends_on:
      - mongo
    restart: always
    networks: ['xes-platform-network']
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: root
